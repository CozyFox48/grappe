<!DOCTYPE html>
<html>
    <head>
        <title>Grape manager</title>
        <meta charset="utf-8">
    </head>
    <body style="display: grid">
        <h1>Grape manager</h1>
        <h4 id="status">Can't connect to Grape</h4>
        <div>
        <label for="buttonName">Button name:</label>
        <input style="display:block" id="buttonName" type="text"/>
        </div>
        <div>
        <label for="0">Action #1</label>
        <input class="suit" id="0" type="text"/>
              <button onclick="emptyStep(0)">Empty</button>
        </div>
        <div>
        <label for="1">Action #2</label>
        <input class="suit" id="1" type="text"/>
        <button onclick="emptyStep(1)">Empty</button>
        </div>
        <div>
        <label for="2">Action #3</label>
        <input class="suit" id="2" type="text"/>
         <button onclick="emptyStep(2)">Empty</button>
        </div>


        <input type="submit" onclick="sendMessage()" value="Send action"/>
    </body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</html>


<style>
  input {
    margin-bottom : 20px
}
</style>
<script type="text/javascript">
var suit = [[], [], []];
var hex = [[], [], []];

$('.suit').keyup(function(e) {
  suit[$(this).attr('id')].push(e.key) // input
  hex[$(this).attr('id')].push("0x"+e.keyCode.toString(16)) // storage
  console.log(hex)
  $(this).val(suit[$(this).attr('id')]+"")
});

  $(document).ready(function() {

   /* waitForConnection(function(socket) {
        $('#status').html("Connected to grape").css({color : "green"})
    })*/
  })

  let socket = new WebSocket('ws://127.0.0.1:1234')
  let initialized = false;
  let sendMessage = null;

  let emptyStep = function(val) {
         $('#'+val).val('');
        suit[val] = [];
        hex[val] = [];
    }
  function waitForConnection(socket) {

    socket.onopen = function (evt) {
      console.log('Opened')
      sendMessage = function() {
        console.log(socket)
        socket.send(
        JSON.stringify({
          buttonName: $("#buttonName").val(),
          keys : [
                 {  type : "suit",
                     keys : hex[0].toString()
                 },
                 {  type : "suit",
                           keys :  hex[1].toString(),
                           },
                           {  type : "text",
                                     keys : hex[2].toString()
                                     }

          ]

        })
        );
      }
    };
    socket.onmessage = function (evt) {
      let response = JSON.parse(evt.data)
      switch (response.event){
        case 'connected' :
          initialized = true;
          console.log(socket)
          $('#status').html(response.message).css({color : "green"})
          break;
      }
    };
    socket.onclose = function(evt) {
      console.log("Connexion closed")
      if(initialized){
        $('#status').html("Connexion to Grape loosed").css({color : "red"})
        socket = new WebSocket('ws://127.0.0.1:1234')
        initialized = false;
        return waitForConnection(socket);
      }


    }
    if(socket.readyState === 3){
      socket = new WebSocket('ws://127.0.0.1:1234')
      return waitForConnection(socket);
    }
    else if(socket.readyState === 1){

    }
    else {
      setTimeout(
          function () {
            return waitForConnection(socket);
          }, 500);
    }


  }

  waitForConnection(socket);

  /*
  */

</script>
